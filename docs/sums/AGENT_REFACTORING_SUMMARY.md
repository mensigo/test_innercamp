# Рефакторинг агента - Сводка изменений

## Дата: 2026-02-11

## Основные изменения

### 1. Добавлены константы
- `CONTEXT_HIST_LIMIT = 10` - лимит истории сообщений
- `MAX_CLARIFICATION_RETRIES = 3` - максимальное количество попыток уточнения параметра

### 2. Новая логика уточнения параметров

Агент теперь поддерживает цикл уточнения недостающих параметров инструментов:
- Если параметр инструмента отсутствует, агент запрашивает его у пользователя
- Поддерживается до 3 попыток уточнения
- После исчерпания попыток пользователю предлагается начать заново

### 3. История сообщений

Добавлена поддержка истории диалога:
- Хранится в памяти в виде списка словарей `{'role': str, 'content': str}`
- Автоматически обрезается до последних 10 сообщений
- Готова к интеграции с LLM для контекстно-зависимых запросов

### 4. Улучшенное логирование

Все `print()` вызовы теперь содержат префиксы формата `[function_name | stage]`:
- `[main | classify_intent]` - этап классификации интента
- `[main | select_tool]` - этап выбора инструмента
- `[main | validate_tool]` - этап валидации параметров
- `[main | clarification]` - этап уточнения параметров
- `[main | execute_tool]` - этап выполнения инструмента

### 5. Обновленные функции

#### `validate_tool_call()`
**Было:** `-> bool`
**Стало:** `-> tuple[bool, str | None]`

Теперь возвращает кортеж:
- `is_valid` - валидность параметров
- `missing_param` - название отсутствующего параметра или `None`

#### Новые функции:

**`generate_clarification_prompt(tool_name: str, missing_param: str) -> str`**
- Генерирует шаблонный уточняющий вопрос для недостающего параметра
- Для `theme`: "На какую тему мне составить хайку? (просьба переформулировать, если вы ее указали ранее)"
- Для `question`: "Уточните ваш вопрос о японской поэзии"

**`extract_param_from_clarification(user_input: str, param_name: str, tool_name: str) -> str | None`**
- Извлекает параметр из ответа пользователя
- Игнорирует неинформативные ответы ("не знаю", "хз", "что-нибудь")
- Обрабатывает конструкции типа "про море" → "море"
- Проверяет длину и валидность

**`add_to_history(history: list[dict], role: str, content: str)`**
- Добавляет сообщение в историю
- Автоматически обрезает до `CONTEXT_HIST_LIMIT` сообщений

### 6. Обновленный основной цикл

Цикл `main()` теперь включает:
1. Инициализацию `message_history` и `pending_clarification`
2. Проверку состояния ожидания уточнения
3. Обработку цикла уточнения с повторными попытками
4. Добавление всех сообщений в историю
5. Улучшенное логирование на каждом этапе

## Примеры работы

### Успешное уточнение
```
Пользователь: напиши хайку
Агент: [main | clarification] На какую тему мне составить хайку? (просьба переформулировать, если вы ее указали ранее)
Пользователь: зимнее утро
Агент: [main | execute_tool] Выполнение generate_haiku
       [main | execute_tool] Тема: зимнее утро
       --- Хайку ---
       ...
```

### Исчерпание попыток
```
Пользователь: хайку мне
Агент: [main | clarification] На какую тему мне составить хайку?
Пользователь: не знаю
Агент: [main | clarification] На какую тему мне составить хайку?
Пользователь: что-нибудь
Агент: [main | clarification] На какую тему мне составить хайку?
Пользователь: хз
Агент: [main | clarification] Не удалось получить параметр. Попробуйте заново.
```

## Тесты

Обновлены и добавлены тесты в `test/s02_simple_haiku/test_agent_integration.py`:
- ✅ Тесты для `validate_tool_call()` с новой сигнатурой
- ✅ Тесты для `generate_clarification_prompt()`
- ✅ Тесты для `extract_param_from_clarification()`
- ✅ Тесты для `add_to_history()` с проверкой лимита
- ✅ Все существующие тесты адаптированы

## Совместимость

- ✅ Обратная совместимость с существующими модулями
- ✅ Не требуется изменений в `classify_intent.py`
- ✅ Не требуется изменений в `select_tool_call.py`
- ✅ Не требуется изменений в RAG и Haiku модулях

## Следующие шаги (опционально)

1. Интеграция истории сообщений в `classify_intent()` для контекстно-зависимой классификации
2. Использование LLM для умного извлечения параметров из сложных ответов
3. Сохранение истории в файл для персистентности между сессиями
4. Добавление метрик и аналитики по успешности уточнений
